---
title: "Environment and latitude standardisation case study"
author: "G. S. Antell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(divvy) 
library(terra) 
library(sf)
```

# Import data

See separate script (format-silurian-data.R) for download and cleaning of raw data.
```{r}
load(file = "C:/Users/sjoh4751/Dropbox/OxfordPDRA/divvy/data/silur.rda")
# data(silur)
```

# Standardise environmental categorisation

```{r data cleanup}
# do not make inference for mixed lithologies
# otherwise, mixed lithology will be overwritten as siliciclastic
  # binned$lithology1[grep('mixed', binned$lithology1)] <- NA 

# The following section is modified from Nurnberg and Aberhan (2013)
# and as written in Antell et al (2020)

# Define variables for search 
  # carb <- c("\"carbonate\"", "\"limestone\"", "\"reef rocks\"", "bafflestone", "bindstone", "dolomite", 
  #           "framestone", "grainstone", "lime mudstone", "packstone", "rudstone", "floatstone",
  #           "wackestone")
  # clast <- c("\"shale\"", "\"siliciclastic\"", "\"volcaniclastic\"", "claystone", "conglomerate",  
  #            "mudstone", "phyllite", "quartzite", "sandstone", "siltstone", "slate", "schist")
shallow <- c("coastal indet.", "delta front", "delta plain",
             "deltaic indet.", "estuary/bay", "foreshore", "interdistributary bay",
             "lagoonal", "lagoonal/restricted shallow subtidal",
             "marginal marine indet.", "open shallow subtidal", "fluvial-deltaic indet.",
             "paralic indet.", "peritidal", "prodelta", "sand shoal",
             "shallow subtidal indet.", "shoreface", "transition zone/lower shoreface",
             "intrashelf/intraplatform reef", "reef, buildup or bioherm",
             "perireef or subreef", "platform/shelf-margin reef") # last 2 lines include reefs
deep <- c("basinal (carbonate)", "basinal (siliceous)", "basinal (siliciclastic)",
          "deep-water indet.", "deep subtidal indet.", "deep subtidal ramp",
          "deep subtidal shelf", "offshore", "offshore indet.",
          "offshore shelf", "slope", "submarine fan", "offshore ramp", 
          "basin reef", "slope/ramp reef") # last line includes deep water reefs

# Lithology
  # l[binned$lithology1 %in% carb] <- "c"  
  # l[binned$lithology1 %in% clast] <- "s"

# Bathymetry
collDat$bath <- NA
collDat$bath[collDat$environment %in% shallow] <- 'prox.' 
collDat$bath[collDat$environment %in% deep]    <- 'deep'
```

# Determine environment in cells and environmental preferences in taxa

- Omit duplicate occurrences?

Rasterise points (should be equal area once projection supported)
```{r rasterise}
ll <- rast(resolution = 5, crs = 'epsg:4326')
prj <- 'ESRI:54030' # Robinson 
# 'EPSG:8858' # "+proj=moll" # 'EPSG:8857' equal earth
rob <- project(ll, prj) 
values(rob) <- 1:ncell(rob)

llOccs <- vect(collDat, geom = c('paleolng','paleolat'), crs = 'epsg:4326')
robOccs <- project(llOccs, prj)
cellMat <- cells(rob, robOccs) 
collDat$cell <- cellMat[,'cell']
xyRob <- xyFromCell(rob, collDat$cell)
cellXY <- c('cellX','cellY')
collDat[,cellXY] <- xyRob

# convert centroids back to lat-long to feed to bandit
# until projected coordinates are supported
  # xyRobSf <- st_as_sf(data.frame(xyRob), coords = c('x','y'), crs='ESRI:54030') 
  # llCellSf <- st_transform(xyRobSf, 'epsg:4326')
  # llCellMat <- st_coordinates(llCellSf)
  # collDat[,c('cellLng','cellLat')] <- llCellMat
```

```{r}
rfRast <- envirise(rob, dat = collDat, cutoff = 0.8,
                   xy = cellXY, env = 'bath')
plot(rfRast)
```

# Spatial standardisation of area and latitude

Split data by enviro category
```{r split occs by enviro class}
# TODO use occ data instead of coll
deepPos <- which(collDat$bath == 'deep')
proxPos <- which(collDat$bath == 'prox.')
deep <- collDat[deepPos,]
prox <- collDat[proxPos,]
```

Subsample within latitudinal bands on each occurrence subset
```{r}
reps <- 100
siteQuota <- 15
binRes <- 10
bandsD <- bandit(dat = deep, 
                 xy = cellXY, iter = reps, 
                 nSite = siteQuota, bin = binRes, 
                 absLat = TRUE, crs = prj, output = 'full')
unique(names(bandsD))

bandsP <- bandit(dat = prox, # different dataset
                 xy = cellXY, iter = reps, 
                 nSite = siteQuota, bin = binRes, 
                 absLat = TRUE, crs = prj, output = 'full')
unique(names(bandsP))
```
Mercifully, the two datasets have data in the same bands.

# Compare diversity across environments

SQS if even, CR if not?
Boxplot colored by depth, x-axis by latitude category
gamma diversity ~ latitude midpoint + depth

```{r}
metaD <- sdsumry(dat = bandsD, taxVar = 'formation', xy = cellXY, crs = prj)
```

