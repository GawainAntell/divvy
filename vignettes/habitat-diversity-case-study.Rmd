---
title: "Environmental and geographic standardisation case study"
author: "G. Antell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: habitat-case-study-refs.bib
vignette: >
  %\VignetteIndexEntry{Environmental and geographic standardisation case study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Goals and limitations of the vignette

*TODO* 
- Explain the aim is to demonstrate project flow for a mock study. Real(istic) data and hypothesis, which are similar to many questions paleobiologists are interested in, e.g. is diversity greater in Gondwana or Laurasia? is connectedness greater across reefal or non-reefal assemblages?
- Results here should *not* be taken as conclusive answer to the research question. Ideally there would be further vetting of both taxonomic and environmental assignments in the PBDB dataset. This vignette ends/should end with suggestions of follow-up directions an analyst might explore before proposing a paleoecological interpretation.
- Another follow-up direction might be to refine environmental categories, e.g. see Jackson 1974 about bivalves that live in <1m depths having hugely widespread ranges - if they can survive there, they can survive most anywhere.

This document consists of four parts, with `divvy` helper functions in `R` code chunks to analyse geographic range size disparities between marine environments.

1. Formatting occurrences (point data)
1. Developing environmental categories (raster data)
1. Spatially subsampling to regions of equal area and dispersion
1. Hypothesis testing using bootstrapped null simulations


## Background on geographic ranges between marine environments

Palaeobiologists often track ecological parameters through time, where, as the package vignette illustrates, it is crucial to standardise differences in spatial coverage between time steps. However, it is equally important to apply spatial standardisation for comparisons between environment or habitat types, even if data occur within one time step.  For instance, consider two habitat types that cover different geographic extents. To determine fairly which habitat hosts more diverse communities, one must account for the difference in spatial coverage. By first subsampling each habitat type into equivalent spatial units, one could then directly and fairly compare richness or other ecological metrics between environments.

In the marine realm, one of the most important environmental axes of ecological differentiation is water depth. Diversity, geographic range size, and other aspects of community structure vary along a gradient of near-shore to deep-water environments. Here, we divide this environmental spectrum coarsely into shallow (proximal) vs. deep (distal) marine habitats. 'Shallow' habitats encompass deltaic, (sub)tidal, and shelf margin environments. 'Deep' habitats include continental slope and offshore settings, generally beginning at 140 m [@Duran2018].

The ecological attribute this case study focusses on is geographic range size, a trait with widespread importance. For instance, range size determines extinction risk to a large degree [@Harnik2012; @Saupe2015]. Range size might influence origination propensity as well, although researchers dispute whether this relationship is positive [@Rosenzweig1995; @Maurer2001], negative [@Hansen1980; @Jablonski2003], or unimodal [@Gaston2003; @Allmon2014]. 

The environmental niche breadth of a taxon strongly controls its geographic distribution; the maximum attainable extent of a taxon's range size is the extent of occurrence of that taxon's suitable habitat. Therefore, for environments within a given ecological niche breadth, a larger geographic distribution of those habitats permits taxa to occupy larger ranges. Taxa may be more restricted than suitable environmental conditions would predict (realised niche breadth), due to biotic or historic factors, but taxa cannot exceed the bounds set by environmental suitability. Since environmental characteristics are more homogeneous in the cold, dark waters of the deep sea than in the topologic complexity of shallow settings, ecologists have long theorised geographic ranges to be larger for deep-dwelling than shallow-water species [@Coe1946; @McClain2010; @Costello2017]. Most empirical tests of this hypothesis have relied upon modern data, however, with relatively little evidence from periods of Earth history when ocean circulation and continental configuration were entirely unlike those of today.

The following sections walk through an analysis to test the expectation geographic ranges are wider for deep- than shallow-water benthic taxa, using brachiopod occurrences from the Silurian (444-419 Ma) recorded in the [Paleobiology Database](https://paleobiodb.org/) (PBDB). Brachiopoda was a diverse clade that made up a large component of Paleozoic benthic communities [@Close2020; @Rojas2021]. In the Paleozoic, much of the world's landmass had coalesced at southermost latitudes into Gondwana, with the remaining continents scattered at the equator and separated by the Iapetus, Paleo-Tethys, Rheic, and Panthalassic oceans (map below). Hence, the geometry of a cosmopolitan marine species' range from the Silurian would differ distinctly from a cosmopolitan range today.

![Silurian palaeogeography, as reconstructed by the PALEOMAP PaleoAtlas project [@Scotese2016].](PALEOMAP_atlas_map75a_Llandovery_430.png)

## Prepare taxonomic occurrence data

PBDB downloads of 1) all marine collections and 2) all Brachiopoda occurrences with accepted names at genus-ranking or below are available as attached datasets in the `divvy` package. Both datasets are subset to relevant columns and are cleaned to remove records missing coordinates. For more information, load the package and query the data objects from the console with `?collSilur` and `?occSilur`. The script to download and vet the raw data is available as `format-data.R` within the GitHub repository [data-raw folder (link)](https://github.com/GwenAntell/divvy/tree/main/data-raw).

```{r imports, message=FALSE}
# terra and sf have all the necessary helper functions for spatial operations
library(terra) 
library(sf)
library(divvy) 
data(collSilur)
data(occSilur)
```

The taxonomic hierarchy and stratigraphic ranges of the occurrence data are standardised against the Sepkoski Compendium already, following the `fossilbrush` package vignette [@fossilbrush]. A further element of cleaning is removal of taxa that occur only once ('space-time singletons' *sensu* @Antell2020). These records contain insufficient information to contribute to geographic range-size calculations.
```{r remove singletons}
nmFreq <- table(occSilur$genus)
sss <- nmFreq[nmFreq == 1] |> names()
sssRows <- occSilur$genus %in% sss
occSilur <- occSilur[ !sssRows, ]
length(sss)
```
This step removed 52 taxa with singular occurrence records.

To disregard trivial differences in coordinate values between points from the same or adjacent localities, the next data treatment is conversion of vector (point) data to raster grid cells. For each PBDB record, the ID and centroid coordinates of its encompassing raster cell are saved in new columns. These cell values will be used in spatial calculations later to improve computation time substantially compared to operations on vector point data.
```{r rasterise}
# initialise Equal Earth projected coordinates
rWorld <- rast()
prj <- 'EPSG:8857'
rPrj <- project(rWorld, prj, res = 200000) # 200,000m is approximately 2 degrees
values(rPrj) <- 1:ncell(rPrj)

# coordinate column names for the current and target coordinate reference system
xyCartes <- c('paleolng','paleolat')
xyCell   <- c('cellX','cellY')

# collection data
llColl <- vect(collSilur, geom = xyCartes, crs = 'epsg:4326')
prjColl <- project(llColl, prj)
collSilur$cell <- cells(rPrj, prjColl)[,'cell']
collSilur[, xyCell] <- xyFromCell(rPrj, collSilur$cell)

# taxon occurrences
llOccs <- vect(occSilur, geom = xyCartes, crs = 'epsg:4326')
prjOccs <- project(llOccs, prj)
occSilur$cell <- cells(rPrj, prjOccs)[,'cell']
occSilur[, xyCell] <- xyFromCell(rPrj, occSilur$cell)
```

## Categorise environment associated with occurrences

To compare ecological parameters between deep and shallow habitat types, the 23 categories in the PBDB `environment` field must first be reclassified to these binary options. The following division of marine environments is copied from scripts of @Antell2020, who adapted the classification of @Nurnberg2013.
```{r define environments}
proxTerms <- c("coastal indet.", "delta front", "delta plain",
               "deltaic indet.", "estuary/bay", "foreshore", "interdistributary bay",
               "lagoonal", "lagoonal/restricted shallow subtidal",
               "marginal marine indet.", "open shallow subtidal", 
               "fluvial-deltaic indet.", "paralic indet.", 
               "peritidal", "prodelta", "sand shoal",
               "shallow subtidal indet.", "shoreface", 
               "transition zone/lower shoreface",
               "intrashelf/intraplatform reef", "reef, buildup or bioherm",
               "perireef or subreef", "platform/shelf-margin reef") 
deepTerms <- c("basinal (carbonate)", "basinal (siliceous)", 
               "basinal (siliciclastic)", "deep-water indet.", 
               "deep subtidal indet.", "deep subtidal ramp",
               "deep subtidal shelf", "offshore", "offshore indet.",
               "offshore shelf", "slope", "submarine fan", "offshore ramp", 
               "basin reef", "slope/ramp reef") 
```

The most accurate environmental information will be that associated directly with occurrence records. Where available, that is what this script will use. However, there are many instances of blank of indeterminate 'environment' field. In those cases, a way to infer probable environment is to determine the predominant environment in the local grid cell based on the environment recorded with any PBDB collections in that cell. A collection in the PBDB can contain any number of occurrences of any number of clades but is tied to a point coordinate - therefore, collections are a rich source of environmental data that is largely independent of occurrences for an individual clade. 

`divvy` provides the `classRast` function to convert environmental occurrence points to a raster grid with a dominant environmental class in each cell. The template raster passed to `classRast` here has the same resolution, extent, and coordinate reference system as above. Here, the function classifies grid cells as proximal or deep-water whenever more than 80% of collections are affiliated with a single environment.
```{r classify collections enviro, fig.width=5.5, fig.align='center'}
collSilur$bath <- NA
collSilur$bath[collSilur$environment %in% proxTerms] <- 'prox' 
collSilur$bath[collSilur$environment %in% deepTerms] <- 'deep'
bathRast <- classRast(rPrj, dat = collSilur, cutoff = 0.8,
                      xy = xyCell, env = 'bath')
plot(bathRast, col = c("#1B9E77", "#D95F02", "black"))
```
A plot of the environmental distribution inferred from collection data traces the mid-latitude continents, albeit with gaps. Very few occurrences appear along the coasts of Gondwana, perhaps largely due to the under-sampling and under-reporting of the corresponding modern continents.

```{r classify occs enviro}
# create a new 'bathCell' column to note the collections-inferred environment
occSilur$bathCell <- occSilur$bath <- extract(bathRast, prjOccs)[['mainClass']]

# refine the enviro where possible based on observations directly linked to occs
occSilur$bath[occSilur$environment %in% proxTerms] <- 'prox' 
occSilur$bath[occSilur$environment %in% deepTerms] <- 'deep'
```

A quick inspection reveals roughly equal numbers of occurrences in each environment. However, there are twice as many shallow as deep-water grid cells as indicated by all marine collections.
```{r relative enviro abundance}
freq(bathRast, bylayer = FALSE)
table(occSilur$bathCell)
table(occSilur$bath)

# what proportion of environments associated with individual records
# match environmental inferences from nearby collections' data?
which(occSilur$bath == occSilur$bathCell) |> 
  length()/nrow(occSilur)
```
The majority of environments inferred from collections data nearby do match the environments associated with occurrence records directly. Most of the discrepancies occur when collection-derived environment was indeterminate and occurrence data contained specific environment terms.

## Assign per-taxon environmental preferences

```{r determine spp preferences}
taxa <- unique(occSilur$genus)

# categorise preferences as binary or nonspecific, based on a given threshold
pref <- function(env, cutoff){
  envTbl <- table(env)
  if (sum(envTbl[1:2])==0) { 'unk' } else {
    envTbl <- envTbl[1:2] / sum(envTbl[1:2]) # proportional enviro abundance
    if (any(envTbl[1:2] > cutoff)) { # check if either envrio is predominant
      ifelse(envTbl[[1]] > cutoff, names(envTbl)[1], names(envTbl)[2])
    } else { 'both' }
  }
}

# tag each row as from a taxon with deep, shallow, or nonspecific preference
occSilur$pref <- NA
cutoff <- 0.7
for (tax in taxa){
 taxBool <- occSilur$genus == tax
 envOccs <- occSilur$bath[taxBool]
 occSilur$pref[taxBool] <- pref(envOccs, cutoff)
}
```

## Spatially subsample each environment

```{r split occ dataset by enviro}
deep <- occSilur[ occSilur$pref == 'deep', ] |>
  uniqify(taxVar = 'genus', xy = xyCell)
prox <- occSilur[ occSilur$pref == 'prox', ] |>
  uniqify(taxVar = 'genus', xy = xyCell)
eury <- occSilur[ occSilur$pref == 'both', ] |>
  uniqify(taxVar = 'genus', xy = xyCell)
# the divvy uniqify() function removes duplicate taxon-cell combinations
# for smaller memory use and faster calculations below

# how many taxa specialise in each?
taxaD <- unique(deep$genus)
taxaP <- unique(prox$genus)
taxaE <- unique(eury$genus)
paste(length(taxaD), 'deep;', length(taxaP), 'shallow;', length(taxaE), 'both')
# cutoff of 0.8 (>80% of occurrences in one habitat) gives 69 deep, 52 shallow
# cutoff of 0.7 gives 94 deep, 61 shallow
```

```{r subsample, error=TRUE}
reps <- 500 # number of subsamples to draw
siteQuota <- 15 # number of sites (equal-area grid cells) in each subsample
siteCol <- 'cell'
r <- 1000 # radial distance in km

set.seed(8)
sampD <- cookies(dat = deep,
                 xy = xyCell, iter = reps,
                 nSite = siteQuota,
                 siteId = siteCol, r = r,
                 weight = TRUE,
                 crs = prj, output = 'full')

set.seed(9)
sampP <- cookies(dat = prox,
                 xy = xyCell, iter = reps,
                 nSite = siteQuota,
                 siteId = siteCol, r = r,
                 weight = TRUE,
                 crs = prj, output = 'full')

set.seed(10)
sampE <- cookies(dat = eury,
                 xy = xyCell, iter = reps,
                 nSite = siteQuota,
                 siteId = siteCol, r = r,
                 weight = TRUE,
                 crs = prj, output = 'full')
```

## Summed Common Occurrence Rate between environments

`divvy` provides the `sdsumry()` function to compute summary statistics about the geographic coverage and diversity of taxon occurrences, as well as the Summed Common species/taxon Occurrence Rate (SCOR). SCOR reflects the degree to which taxa are common/widespread and is decoupled from richness or abundance [@Hannisdal2012]. SCOR is calculated as the sum across taxa of the log probability of incidence; very widespread taxa make a large contribution to an assemblage SCOR, while rare taxa have relatively little influence. When a taxon is present in *all* sampled locations, its log probability of incidince is infinite---
```{r calculate subsample SCORs}
metaD <- sdsumry(sampD, 'genus', xyCell, prj)
metaP <- sdsumry(sampP, 'genus', xyCell, prj)
metaE <- sdsumry(sampE, 'genus', xyCell, prj)

# check for infinity values of SCOR and remove them
is.infinite(metaD$SCOR) |> any() # none in deep habitat dataset
is.infinite(metaP$SCOR) |> any() # but some in the prox habitat dataset
is.infinite(metaE$SCOR) |> any() # and some in the all-habitats dataset

infP <- is.infinite(metaP$SCOR)
metaP <- metaP[ !infP, ]
infE <- is.infinite(metaE$SCOR)
metaE <- metaE[ !infE, ]
# sum(infP); sum(infE) # 10 in prox, 2 in eury

# removing subsamples with these cases means sample-sizes may differ
# so remove an equal number of subsamples from the other environment dataset
  # set.seed(10)
  # rows2toss <- sample(1:reps, nInf)
  # metaP <- metaP[-rows2toss, ]

# make sample size (of subsamples) equal, by removing ones with highest SCOR
lowestN <- min(nrow(metaD), nrow(metaP), nrow(metaE))
sortD <- order(metaD$SCOR, decreasing = FALSE)
metaD <- metaD[sortD, ]
metaD <- metaD[1:lowestN, ]
sortE <- order(metaE$SCOR, decreasing = FALSE)
metaE <- metaE[sortE, ]
metaE <- metaE[1:lowestN, ]
```


```{r test enviro differences in SCOR}
testDiff <- function(dat1, dat2, vTest){
  n <- nrow(dat1)
  dat1 <- dat1[ sample(1:n), ]
  dat2 <- dat2[ sample(1:n), ]
  h1obs <- dat2[, vTest] > dat1[, vTest]
  sum(h1obs) / n
}
diffDist <- function(dat1, dat2, vTest, nReps){
  testStatDist <- testDiff(dat1, dat2, vTest) |> replicate(n = nReps)
  avg <- mean(testStatDist)
  ci95 <- c(0.025, 0.975)
  null95 <- quantile(testStatDist, ci95)
  names(null95) <- c('nullLwrCI', 'nullUprCI')
  c(null95, 'mean' = avg)
}

# do deep-water environments harbor more cosmopolitan taxa?
diffDist(metaP, metaD, vTest = 'SCOR', nReps = 1000)
# what about eurytopic taxa vs. deep-water specialists?
diffDist(metaD, metaE, vTest = 'SCOR', nReps = 1000)
# and if eurytopic species are more widespread than deep,
# they'll also be more widespread than proximal-dwellers
# (since more deep-water species are widespread than proximal are)
diffDist(metaP, metaE, vTest = 'SCOR', nReps = 1000)
```
A random region of deep-water habitat contains more taxa with widespread ranges than a proximal habitat two-thirds of the time. Assemblages of eurytopic taxa from any random region always contained representatives with more widespread ranges than assemblages of either habitat specialist.

On average, average SCOR values from assemblages of deep-water taxa were slightly larger than those of proximal taxa, while eurytopic taxa were substantially more common than either of those groups as measured by SCOR. Because these results are derived from spatially-standardised data, they take into account the fact eurytopic taxa as defined here had many more cells of suitable habitat available to occupy.
```{r summary subsample SCORs}
summary(metaD$SCOR)
summary(metaP$SCOR)
summary(metaE$SCOR)
```

### Contrast results from non-subsampled data

In this case it turns out subsampling makes the result more pronounced, that eurytopic species are more often super-widespread than specialists in either habitat.
```{r calculate global SCORs}
sdsumry(deep, 'genus', xyCell, prj) |> round(digits = 2)
sdsumry(prox, 'genus', xyCell, prj) |> round(digits = 2)
sdsumry(eury, 'genus', xyCell, prj) |> round(digits = 2)

# results for cutoff = 0.7, radius = 1000
# > sdsumry(deep, 'genus', xyCell, prj) |> round(digits = 2)
#      nOcc nLoc centroidX centroidY latRange greatCircDist meanPairDist minSpanTree SCOR nTax
# [1,]  713  250  -3192759  -1735760   166.32      33567.84       8071.8    130946.3    3   94
# > sdsumry(prox, 'genus', xyCell, prj) |> round(digits = 2)
#      nOcc nLoc centroidX centroidY latRange greatCircDist meanPairDist minSpanTree SCOR nTax
# [1,]  432  204  -3766508   -957619   166.32      33567.84      7845.98      127435 2.27   61
# > sdsumry(eury, 'genus', xyCell, prj) |> round(digits = 2)
#      nOcc nLoc centroidX centroidY latRange greatCircDist meanPairDist minSpanTree SCOR nTax
# [1,] 3462  404  -3134553  -1227392   166.32      33567.84      8321.72    168862.1 9.46  100
```

## Average taxon range size between environments


```{r calculate per-taxon range size in subsamples}
subsampRange <- function(taxa, df, taxCol, coordCols, crs){
  taxRange <- function(taxon){
    taxBool <- df[, taxCol] == taxon
    if (sum(taxBool) == 0){ # case where taxon unsampled
      rep(NA, 7)
    } else {
      taxCoords <- df[taxBool, coordCols]
      rangeSizer(taxCoords, crs)
    }
  }
  taxa <- sort(taxa)
  rngMat <- sapply(taxa, taxRange)
  rownames(rngMat) <- c('occurrences', 'centroidX', 'centroidY', 'latRange',
                        'greatCircDist', 'meanPairDist', 'minSpanTree')
  rngDf <- t(rngMat) |> data.frame()
  return(rngDf)
}

rngD <- lapply(sampD, FUN = subsampRange, taxa = taxa, taxCol = 'genus', 
               coordCols = xyCell, crs = prj)
rngP <- lapply(sampP, FUN = subsampRange, taxa = taxa, taxCol = 'genus', 
               coordCols = xyCell, crs = prj)
rngE <- lapply(sampE, FUN = subsampRange, taxa = taxa, taxCol = 'genus', 
               coordCols = xyCell, crs = prj)
```


```{r average range size across subsamples}
# summarize a focal species' range size data across all subsamples
taxRange <- function(a, rngL, singletons = FALSE){
  tmp <- lapply(rngL, function(x){
    aBool <- row.names(x) == a
    x[ aBool, ]
  })
  aDf <- do.call(rbind, tmp)
  # option: only consider subsamples where species is sampled multiple times
  if (singletons == FALSE){
    singl <- aDf$occ == 1
    aDf <- aDf[ !singl, ]
  }
  colMeans(aDf, na.rm = TRUE)
}

# test case
crass <- taxRange('Crassitestella', rngD)
round(crass, 2)

# apply summary function over all taxa in subsamples of preferred enviro
rngAvgD <- sapply(taxaD, taxRange, rngL = rngD) |>
  t() |> data.frame()
rngAvgP <- sapply(taxaP, taxRange, rngL = rngP) |>
  t() |> data.frame()
rngAvgE <- sapply(taxaE, taxRange, rngL = rngE) |>
  t() |> data.frame()
# sum(! is.na(rngAvgD$occurrences)) # taxon sample size
# sum(! is.na(rngAvgP$occurrences))
# sum(! is.na(rngAvgE$occurrences))
```

```{r}
rngVars <- c('occurrences', 'meanPairDist', 'minSpanTree')
summary(rngAvgD[rngVars])
summary(rngAvgP[rngVars])
summary(rngAvgE[rngVars])

t.test(sqrt(rngAvgE$minSpanTree), sqrt(rngAvgD$minSpanTree), alternative='g')
wilcox.test((rngAvgE$occurrences), (rngAvgD$occurrences), alternative='g')

t.test(sqrt(rngAvgD$minSpanTree), sqrt(rngAvgP$minSpanTree), alternative='g') # *
wilcox.test((rngAvgD$occurrences), (rngAvgP$occurrences), alternative='g')
```


### Contrast results from non-subsampled data

```{r}
unsamp <- subsampRange(taxa, occSilur, 'genus', xyCell, prj)
unsampD <- unsamp[rownames(unsamp) %in% taxaD,]
unsampP <- unsamp[rownames(unsamp) %in% taxaP,]
unsampE <- unsamp[rownames(unsamp) %in% taxaE,]

t.test(sqrt(unsampE$minSpanTree), sqrt(unsampD$minSpanTree), alternative='g')
wilcox.test((unsampE$occurrences), (unsampD$occurrences), alternative='g')

t.test(sqrt(unsampD$minSpanTree), sqrt(unsampP$minSpanTree), alternative='g') # *
wilcox.test((unsampD$occurrences), (unsampP$occurrences), alternative='g')
```

## References
