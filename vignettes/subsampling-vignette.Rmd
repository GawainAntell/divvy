---
title: "Spatial Subsampling Vignette"
author: "G. S. Antell"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: rmarkdown::html_vignette
bibliography: vignette-refs.bib
vignette: >
  %\VignetteIndexEntry{Spatial Subsampling Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview

Brief, self-contained explanation of why to standardise spatial extent and area

What this vignette covers

# Prepare Paleobiology Database records of Pliocene bivalves

We begin by loading the `divDivvy` package itself, as well as its geospatial package dependencies `sf`, `units`, and `vegan`, and the `iNEXT` package for taxonomic richness rarefaction. The `icosa` package offers a convenient way to convert vector coordinate data to equal-area raster cells in the empirical examples that follow.
```{r setup, message=FALSE}
library(divDivvy)
library(sf)
library(units)
library(vegan)
library(iNEXT)
library(icosa)
```

`divDivvy` includes three attached datasets: `bivalves`, `dinos`, and `trilos`. Each dataset is a download of fossil occurrences from the [Paleobiology Database](https://paleobiodb.org/) (PBDB) that has been subset to a few relevant columns and minimally cleaned. `bivalves` contains ca. 8,000 (palaeo)coordinates and identifications for ca. 500 marine bivalve genera from the Pliocene. The datasets are provided only as examples for working with PBDB-structured occurrence records; formal analyses would be wise to vet downloaded data more rigorously, including revising taxonomy, time bin assignments, and environmental classifications.
```{r}
data(bivalves)
head(bivalves)
nrow(bivalves)
length(unique(bivalves$genus))
```

The latitude-longitude coordinates in the PBDB come from many different studies, which means the precision and accuracy vary across records. Fossils collected from the same section may be reported with different coordinates due purely to different GPS equipment, mapping, or decimal rounding of field workers, for example. The spatial subsampling procedures below put great weight on the number of unique localities in a region, so it is important to avoid inflating the site number artificially.

One standard way to smooth over slight discrepancies in occurrence positions is to convert coordinates ('vector' spatial data) to grid cells ('raster' spatial data)^[If vector and raster data are new concepts, a well-curated resource for learning the essentials of working with spatial data in R is [rspatial.org](https://rspatial.org/terra/spatial/index.html).]. Effectively, we lay a web over a study region and record the position of the polygon in which points fall rather than the original xy point coordinates. An additional advantage of raster over point data is the tremendous increase in efficiency of later spatial computations.

Palaeobiologists often reduce grid-cell occurrences for a taxon from abundance counts to binary presence-absence data. This practice is especially common for PBDB data because abundance information is usually non-standard if it is recorded at all. (Read on below for further notes about duplicate taxon occurrences, however.)

Many PBDB analyses will also be global in extent, which makes the choice of [coordinate reference system](https://rspatial.org/terra/spatial/6-crs.html) for the raster grid important. The areas and shapes of grid cells at the poles vs. the equator can differ widely with certain reference systems or map projections. A friendly raster grid system developed by palaeobiologist Ádám Kocsis is the `icosa` package's tessellations of pentagons and hexagons. The polygons are approximately equal in area and shape across the globe. The spatial resolution of the grid is controlled by the arguments to the `hexagrid` function.

```{r}
# initialise a grid of ca. 10,000 hexagons/pentagons
hgrid <- hexagrid( c(8,4) )
# retrieve IDs of polygon faces at occurrence points
faceIds <- locate(hgrid, bivalves[, c('paleolng','paleolat')] ) 
# check for no (very rare) cases of any points falling exactly on an edge/vertex
onEdge <- sum( is.na(faceIds) )
if (onEdge > 0){
  print(paste(onEdge, 'points on vertex or edge, cannot return face'))
}
# retrieve latitude-longitude coordinates of polygon centroids
cntrd <- data.frame( pos(hgrid, faceIds) )
bivalves[, c('cellLng','cellLat')] <- cntrd
bivalves$face <- faceIds

# TODO plot map
```

# Spatially subsample in regions

`divDivvy` offers three approaches to spatially subsample data:

* `cookies` Imposes a radial constraint on the spatial extent of a subsample and standardises area by rarefying the number of localities

* `clustr` Imposes a maximum diameter on the spatial extent of a subsample, aggregates sites that are nearest neighbours (connecting them with a minimum spanning tree), and optionally rarefies localities

* `bandit` Rarefies the number of localities within bands of equal latitude

Subsamples are returned as elements in a list of length `iter`. If `output = "locs"`, each element is a data.frame of coordinates for the `nSite` sites included in a subsample. This output may be useful as an intermediate object on which to run custom functions that calculate ecological parameters of interest, for instance metrics of spatial connectedness among fossil sites.
```{r circ subsample}
set.seed(7)
circLocs <- cookies(dat = bivalves, siteId = 'face', 
                    xy = c('cellLng','cellLat'), 
                    r = 1000, # radial distance in km
                    nSite = 8, iter = 500,
                    output = 'locs')
length(circLocs)
circLocs[[1]]

# TODO colour in subsampled points on earlier map
```

If `output = "full"`, each element contains the subset of occurrence rows from `bivalves` located at the sites in a subsample.
```{r circ subsample variation}
set.seed(7)
circOccs <- cookies(dat = bivalves, siteId = 'face', 
                    xy = c('cellLng','cellLat'), 
                    r = 1000, # radial distance in km
                    nSite = 8, iter = 500,
                    output = 'full')
head( circOccs[[1]] )
```

## Considerations regarding PBDB collections and references

Note that the data fed into the subsampling function can contain duplicate taxon-location records. For instance, the subsample output printed above shows two genera (*Ennucula* and *Saccella*) each occur at least twice at the same coordinates (raster cell #F4323). Internally, the subsampling functions subset the input data *a priori* to unique localities, so duplicate records are irrelevant. If one is interested in the number of sampled PBDB collections or references, however, then it is necessary to retain all original occurrences. In the example above, the duplicates stem from different collections (#41542 and #41543 for *Ennucula* and #41541 and #41542 for *Saccella*). We have standardised spatial extent and area, but at this point we could now rarefy the number of collections or references, too, as a standardisation for sampling effort.

The study that developed the circular buffer approach for regional subsampling (implemented with \code{cookies}) avoided rarefying collections/references, as this step would be largely redundant with rarefying sites/raster grid cells [@Antell2020]. The number of PBDB reference counts for marine invertebrate occurrences correlates nearly perfectly with grid cell counts [@Alroy2008]. Applying rarefaction to both grid cells and collections or references would compress the distribution of observed values, which could reduce the statistical power of analysis and heighten the risk of overlooking a true biological signal (type 2 error).

In contrast, the study that developed the minimum-spanning-tree (MST) approach for regional subsampling rarefied collections within references, following @Alroy2014, but avoided rarefying sites/cells [@Close2017]. The richness estimation procedure involved drawing PBDB references, drawing up to three collections within each of those references, and evaluating only the taxon occurrences within those subsampled collections. The \code{divDivvy} diversity summary function (\code{sampMeta}) and the most recent study to use MST subsamples [@Close2020] call on the \code{iNEXT} implementation of coverage-based richness estimation, which lacks this PBDB-specific functionality. Therefore, users should write custom richness estimation scripts or adapt Alroy's Perl script to rarefy collections and/or references if desired.

## Recommendation to subsample sites

There is an option in \code{clustr} to turn off site rarefaction (argument \code{nSite = NULL}), for backwards comparability with its originator publications described above. 

```{r MST subsample}
forrest <- clustr(dat = bivalves, distMax = 1500,
                  xy = c('cellLng','cellLat'), iter = 100,
                  nMin = 3, # nSite = 8,
                  output = 'full')
```

"Our focal results are based on spatial regions that simultaneously satisfy all of the following requirements: 1) a spatial extent of 1500, 2000, 2500, 3000 and 3500 km MST distance ±10%; 2) a minimum-spanning tree for which the longest branch is less than half of the desired MST length (i.e., the region does not represent two widely-separated clusters of localities with no sampling in-between); 3) at least five occupied grid cells (100 km spacings) per 40 thousand km of MST length, ensuring a minimum level of spatial coverage within each spatial region; 4) at least 15 references per thousand km of MST length, ensuring a minimum level of 5 research effort for each spatial region; 5) at least 20 collections; and 6) a multiton ratio of at least 0.2, ensuring a minimum level of sample completeness."


# Spatially subsample by latitude

```{r lat subsample}
bands <- bandit(dat = bivalves, width = 15,
                xy = c('cellLng','cellLat'), centr = FALSE,
                nSite = 8, iter = 10, absLat = FALSE
                )
```

# Analysis on subsampled data

Exclude dominant for SQS: done in Close 2020 and Alroy 2008 but not Alroy 2014.

```{r meta data}
# smry <- sampMeta(dat = forrest[[1]], taxVar = 'genus', 
#                  collections = 'collection_no', 
#                  xy = c('cellLng','cellLat'),
#                  quotaQ = 0.2, quotaN = 10,
#                  omitDom = TRUE)
# smry

# TODO range size per species and per sample
```

# References
