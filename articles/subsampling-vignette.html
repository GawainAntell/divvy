<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="divvy">
<title>Spatial subsampling tutorial • divvy</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial subsampling tutorial">
<meta property="og:description" content="divvy">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">divvy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-getting-started">Getting started</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-getting-started">
    <a class="dropdown-item" href="../articles/subsampling-vignette.html">Subsampling tutorial</a>
    <a class="dropdown-item" href="../articles/habitat-rangesize-case-study.html">Range size case study</a>
    <a class="dropdown-item" href="../articles/subsampling-concept-walkthrough.html">Conceptual walkthrough</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/GawainAntell/divvy/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Spatial subsampling tutorial</h1>
                        <h4 data-toc-skip class="author">G. T.
Antell</h4>
            
            <h4 data-toc-skip class="date">17 October 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/GawainAntell/divvy/blob/HEAD/vignettes/subsampling-vignette.Rmd" class="external-link"><code>vignettes/subsampling-vignette.Rmd</code></a></small>
      <div class="d-none name"><code>subsampling-vignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="contents">Contents<a class="anchor" aria-label="anchor" href="#contents"></a>
</h2>
<ul>
<li><p>Why to subsample spatially</p></li>
<li><p>Prepare Paleobiology Database records</p></li>
<li>
<p>Subsampling examples</p>
<ul>
<li><p>Circular subsampling</p></li>
<li><p>PBDB collections, references, and duplicate entries</p></li>
<li><p>Nearest-neighbour subsampling</p></li>
<li><p>Latitudinal subsampling</p></li>
</ul>
</li>
<li><p>Analysis on subsampled data</p></li>
<li><p>References</p></li>
</ul>
<p>This document introduces rationale for spatial subsampling and covers
common use cases for <code>divvy</code> functions, including example R
code. Sections below discuss ways to format data, implement three
different subsampling routines, and calculate common biodiversity
metrics.</p>
</div>
<div class="section level2">
<h2 id="why-to-subsample-spatially">Why to subsample spatially<a class="anchor" aria-label="anchor" href="#why-to-subsample-spatially"></a>
</h2>
<p>Biodiversity measures, whether quantified from fossil or extant data,
reflect the outcome of three types of processes: 1. the biological
processes the measurements aim to capture, 2. stochastic processes that
generate random error, and 3. observation processes, such as the
distribution of collecting effort intensity. Compared to neontological
data, observation densities of palaeontological data reflect the
additional contributions of taphonomy (decay and preservation processes)
and sedimentation (burial and lithification processes). The term
‘sampling’ is used herein to refer to the full suite of influences on
how many of the fossil taxa that lived in a place are recorded as fossil
occurrences there. Given the large number of processes involved in
sampling fossils, it is unsurprising that for many palaeo-occurrence
datasets, the combined effect size of unexplained error and variable
observation probabilities on biodiversity parameter estimates is greater
than that of true biological processes from the past.</p>
<p>The relative strength of sampling structure compared to biological
structure is a well-known issue in quantitative palaeobiology and
therefore has received considerable attention. The most mainstream
method of standardising sampling in biodiversity data (fossil or extant)
is rarefaction, a genre of statistical method that resamples taxon
occurrences to a given threshold of sampling completeness. ‘Classical’
rarefaction uses cumulative specimen count as a proxy of sampling
completeness, while ‘coverage-based’ rarefaction estimates the
cumulative coverage of a taxon frequency distribution curve as a proxy
<span class="citation">(Alroy 2010; Chao and Jost 2012)</span>. Examples
of both types of rarefaction abound in recent palaeobiology literature.
Rarefaction largely succeeds in producing diversity estimates corrected
for sampling differences between sites, i.e. diversity estimates at
discrete sites (<em>alpha</em> diversity) that can be compared fairly.
However, challenges arise in comparing diversity between times or
regions that contain multiple sites.</p>
<p>Taxonomic composition turns over from one geographic location to
another. The amount of this turnover (<em>beta</em> diversity) generally
increases with distance, a relationship known as the species–area
effect. In practical terms, the greater the spatial dispersion or area
of sampling, the more taxa will tend to be recovered. Sampling processes
control both the dispersion and area of localities with fossil data,
which makes it essential for palaeobiologists to account for spatial
coverage of sampling when conducting biodiversity analyses, regardless
of the use of rarefaction <span class="citation">(Benson et al.
2021)</span>. Without standardising sampling in a spatial context, any
estimates of biodiversity parameters will be an indiscernible mix of
true historic values conflated with the amount of observation of those
values.</p>
<p><code>divvy</code> implements several spatial subsampling methods
that control both the geographic dispersion and area of taxon
occurrences, so analysts can make fairer estimates of biodiversity
parameters between regions or through time. Each method is iterative,
drawing many, comparable spatial replicates.</p>
</div>
<div class="section level2">
<h2 id="prepare-paleobiology-database-records">Prepare Paleobiology Database records<a class="anchor" aria-label="anchor" href="#prepare-paleobiology-database-records"></a>
</h2>
<p>We begin by loading the <code>divvy</code> package itself, and note
its geospatial package dependencies <code>units</code>, <code>sf</code>,
<code>terra</code>, and <code>vegan</code>, and the <code>iNEXT</code>
package for taxonomic richness rarefaction.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gawainantell.github.io/divvy/">divvy</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/" class="external-link">units</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vegandevs/vegan" class="external-link">vegan</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://chao.stat.nthu.edu.tw/wordpress/software_download/" class="external-link">iNEXT</a></span><span class="op">)</span></span></code></pre></div>
<p><code>divvy</code> includes the attached dataset
<code>bivalves</code>, a download of fossil occurrences from the <a href="https://paleobiodb.org/" class="external-link">Paleobiology Database</a> (PBDB) that has
been subset to a few relevant columns and minimally cleaned.
<code>bivalves</code> contains ca. 8,000 (palaeo)coordinates and
identifications for ca. 500 marine bivalve genera from the Pliocene. For
more information about the dataset, query <code><a href="../reference/bivalves.html">?bivalves</a></code>.</p>
<p>The attached dataset is provided only as an example for working with
PBDB-structured occurrence records; formal analyses would be wise to vet
downloaded data more rigorously, including revising taxonomy, time bin
assignments, and environmental classifications. The
<code>fossilbrush</code> package provides a palette of tools to help
clean PBDB data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">bivalves</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bivalves</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;         genus paleolng paleolat collection_no reference_no</span></span>
<span><span class="co">#&gt; 1        Lima   176.85   -42.69         34849         9315</span></span>
<span><span class="co">#&gt; 2 Nemocardium   176.85   -42.69         34849        11706</span></span>
<span><span class="co">#&gt; 3      Ostrea   176.85   -42.69         34849        11706</span></span>
<span><span class="co">#&gt; 4     Chlamys   176.85   -42.69         34849         9315</span></span>
<span><span class="co">#&gt; 5  Pycnodonte  -114.37    33.76         34857         9338</span></span>
<span><span class="co">#&gt; 6      Euvola  -114.37    33.76         34857         9338</span></span>
<span><span class="co">#&gt;              environment max_ma min_ma          accepted_name</span></span>
<span><span class="co">#&gt; 1             basin reef  5.333    3.6                   Lima</span></span>
<span><span class="co">#&gt; 2             basin reef  5.333    3.6 Nemocardium (Pratulum)</span></span>
<span><span class="co">#&gt; 3             basin reef  5.333    3.6       Ostrea chilensis</span></span>
<span><span class="co">#&gt; 4             basin reef  5.333    3.6                Chlamys</span></span>
<span><span class="co">#&gt; 5 marginal marine indet.  5.333    3.6   Pycnodonte heermanni</span></span>
<span><span class="co">#&gt; 6 marginal marine indet.  5.333    3.6           Euvola keepi</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bivalves</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 8095</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bivalves</span><span class="op">$</span><span class="va">genus</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 550</span></span></code></pre>
<p>The latitude-longitude coordinates in the PBDB come from many
different studies, which means the precision and accuracy vary across
records. Fossils collected from the same locality may be reported with
different coordinates due purely to different GPS equipment, mapping, or
decimal rounding, for example. The spatial subsampling procedures below
put great weight on the number of unique localities in a region, so it
is important to avoid inflating the site number artificially.</p>
<p>One standard way to smooth over slight discrepancies in occurrence
positions is to convert point coordinates (‘vector’ spatial data) to
grid cells (‘raster’ spatial data)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;If vector and raster data are new concepts, a
well-curated resource for learning the essentials of working with
spatial data in R is &lt;a href="https://rspatial.org/spatial/2-spatialdata.html" class="external-link"&gt;rspatial.org&lt;/a&gt;.&lt;/p&gt;'><sup>1</sup></a>. Effectively, one lays a web over a study
region and records the position of polygons (‘grid cells’) in which
points fall, rather than the original xy point coordinates. An
additional advantage of raster over vector data is the tremendous
increase in efficiency of spatial computations.</p>
<p>Palaeobiologists often convert abundance counts to binary
presence-absence data for taxon occurrences in grid cells. This practice
is especially common for PBDB data because abundance information is
usually non-standard, if it is recorded at all. (Read below for further
notes about duplicate taxon occurrences.)</p>
<p>Many PBDB analyses are also global in extent, which makes the choice
of <a href="https://rspatial.org/spatial/6-crs.html" class="external-link">coordinate
reference system</a> for the raster grid important. The areas and shapes
of grid cells at the poles vs. the equator can differ widely with
certain reference systems or map projections. The code below converts
latitude-longitude coordinates to the Equal Earth reference system, an
equal-area projection for world maps. Another option of friendly raster
grid system is the is the <code>icosa</code> package, developed by
palaeobiologist Ádám Kocsis, which creates tessellations of pentagons
and hexagons. The polygons are approximately equal in area and shape
across the globe. The spatial resolution of the grid is controlled by
arguments in the <code>hexagrid</code> function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># initialise Equal Earth projected coordinates</span></span>
<span><span class="va">rWorld</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">prj</span> <span class="op">&lt;-</span> <span class="st">'EPSG:8857'</span></span>
<span><span class="va">rPrj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">rWorld</span>, <span class="va">prj</span>, res <span class="op">=</span> <span class="fl">200000</span><span class="op">)</span> <span class="co"># 200,000m is approximately 2 degrees</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">rPrj</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">rPrj</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># coordinate column names for the current and target coordinate reference system</span></span>
<span><span class="va">xyCartes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'paleolng'</span>,<span class="st">'paleolat'</span><span class="op">)</span></span>
<span><span class="va">xyCell</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'cellX'</span>,<span class="st">'cellY'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># retrieve coordinates of raster cell centroids</span></span>
<span><span class="va">llOccs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">bivalves</span>, geom <span class="op">=</span> <span class="va">xyCartes</span>, crs <span class="op">=</span> <span class="st">'epsg:4326'</span><span class="op">)</span></span>
<span><span class="va">prjOccs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">llOccs</span>, <span class="va">prj</span><span class="op">)</span></span>
<span><span class="va">bivalves</span><span class="op">$</span><span class="va">cell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/cells.html" class="external-link">cells</a></span><span class="op">(</span><span class="va">rPrj</span>, <span class="va">prjOccs</span><span class="op">)</span><span class="op">[</span>,<span class="st">'cell'</span><span class="op">]</span></span>
<span><span class="va">bivalves</span><span class="op">[</span>, <span class="va">xyCell</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/xyCellFrom.html" class="external-link">xyFromCell</a></span><span class="op">(</span><span class="va">rPrj</span>, <span class="va">bivalves</span><span class="op">$</span><span class="va">cell</span><span class="op">)</span></span></code></pre></div>
<p>We can inspect the spatial distribution of data by converting
occurrence points to <code>spatial features</code> (a class that
contains coordinate system information) and plotting them against a
basic world map, supplied here from the <code>rnaturalearth</code> and
<code>rnaturalearthdata</code> packages.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occUniq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uniqify.html">uniqify</a></span><span class="op">(</span><span class="va">bivalves</span>, <span class="va">xyCell</span><span class="op">)</span></span>
<span><span class="va">ptsUniq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">occUniq</span>, coords <span class="op">=</span> <span class="va">xyCell</span>, crs <span class="op">=</span> <span class="va">prj</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearthdata" class="external-link">rnaturalearthdata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># for plot visualisation</span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="va">worldP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">world</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ptsUniq</span>, shape <span class="op">=</span> <span class="fl">17</span>, color <span class="op">=</span> <span class="st">'blue'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">worldP</span><span class="op">)</span></span></code></pre></div>
<p><img src="subsampling-vignette_files/figure-html/map%20data-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="subsampling-examples">Subsampling examples<a class="anchor" aria-label="anchor" href="#subsampling-examples"></a>
</h2>
<p><code>divvy</code> offers three approaches to spatially subsample
data:</p>
<ul>
<li><p><code>cookies</code>: Imposes a radial constraint on the spatial
bounds of a subsample and standardises area by rarefying the number of
localities</p></li>
<li><p><code>clustr</code>: Aggregates sites that are nearest neighbours
(connecting them with a minimum spanning tree) to impose a maximum
diameter on the spatial bounds of a subsample, and optionally rarefies
localities</p></li>
<li><p><code>bandit</code>: Rarefies the number of localities within
bands of equal latitude</p></li>
</ul>
<div class="section level3">
<h3 id="circular-subsampling">Circular subsampling<a class="anchor" aria-label="anchor" href="#circular-subsampling"></a>
</h3>
<p>First let’s apply circular subsampling, which both constrains the
spatial bounds of a sample to a specified radius from a random start
point and standardises the spatial area of a sample to a specified
number of sites. (Recall that sites were allocated to equal-area
polygons in the preceding section.) The radius (1500 km) and the numbers
of sites (n = 12) and iterations (n = 500) are specified here to match
the subsampling parameters in the global analysis of <span class="citation">Antell et al. (2020)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">circLocs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cookies.html">cookies</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">bivalves</span>,  </span>
<span>                    xy <span class="op">=</span> <span class="va">xyCell</span>,</span>
<span>                    iter <span class="op">=</span> <span class="fl">500</span>, </span>
<span>                    nSite <span class="op">=</span> <span class="fl">12</span>, </span>
<span>                    r <span class="op">=</span> <span class="fl">1500</span>, <span class="co"># radial distance in km</span></span>
<span>                    weight <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># probabilistically aggregate subsampling sites</span></span>
<span>                    crs <span class="op">=</span> <span class="va">prj</span>, <span class="co"># Equal Earth projection</span></span>
<span>                    output <span class="op">=</span> <span class="st">'locs'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">circLocs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 500</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">circLocs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;         cellX   cellY</span></span>
<span><span class="co">#&gt; 1019 -6543959 4739440</span></span>
<span><span class="co">#&gt; 56   -7343959 3539440</span></span>
<span><span class="co">#&gt; 7586 -7143959 3939440</span></span>
<span><span class="co">#&gt; 1278 -7343959 3939440</span></span>
<span><span class="co">#&gt; 1049 -6543959 4539440</span></span>
<span><span class="co">#&gt; 2921 -7143959 3539440</span></span>
<span><span class="co">#&gt; 1054 -6743959 4339440</span></span>
<span><span class="co">#&gt; 1076 -6743959 4539440</span></span>
<span><span class="co">#&gt; 122  -7743959 3939440</span></span>
<span><span class="co">#&gt; 1251 -7543959 3939440</span></span>
<span><span class="co">#&gt; 2065 -7543959 3739440</span></span>
<span><span class="co">#&gt; 911  -6543959 4339440</span></span></code></pre>
<p>Subsamples are returned as elements in a <code>list</code> of length
<code>iter</code>. If <code>output = "locs"</code> (default), each
element is a <code>data.frame</code> of coordinates for the
<code>nSite</code> sites included in a subsample. This output may be
useful as an intermediate object on which to run custom functions that
calculate ecological parameters of interest, for instance metrics of
spatial connectedness among fossil sites. We can also use location
output to explore where the subsample plots on our earlier map. This
subsample happens to fall along the East and Gulf Coasts of North
America.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># over-plot the subsample locations</span></span>
<span><span class="va">smplPts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">circLocs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, coords <span class="op">=</span> <span class="va">xyCell</span>, crs <span class="op">=</span> <span class="va">prj</span><span class="op">)</span></span>
<span><span class="va">worldP</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">smplPts</span>, shape <span class="op">=</span> <span class="fl">17</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="subsampling-vignette_files/figure-html/map%20subsample-1.png" width="576" style="display: block; margin: auto;">
Now note that the first code chunk in this section set the
<code>weight</code> argument of <code><a href="../reference/cookies.html">cookies()</a></code> to
<code>TRUE</code>. Weighting is designed to cluster subsample sites more
compactly than random selection; that is, distant points will tend to be
left out. Weighting is achieved by increasing the probability of drawing
a site the closer it falls to the central occurrence point (‘seed cell’)
in a given subsample. The seed cell is always included in weighted
subsamples (but not necessarily in unweighted ones) and corresponds to
the first row listed in the output. To visibilise the weighted subsample
method further, let’s extract the seed location and manually plot the
circular constraint around it.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cntr</span> <span class="op">&lt;-</span> <span class="va">smplPts</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span><span class="co"># distances inferred to be meters based on lat-long coord system</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">1500</span></span>
<span><span class="va">buf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">cntr</span>, dist <span class="op">=</span> <span class="va">r</span><span class="op">*</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># over-plot subsample boundary region and included sites</span></span>
<span><span class="va">worldP</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">smplPts</span>, shape <span class="op">=</span> <span class="fl">17</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">buf</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="subsampling-vignette_files/figure-html/count%20pool%20size-1.png" width="576" style="display: block; margin: auto;">
This inspection also reveals that there happen to be 14 sites in the
region from which to draw a subsample of 12.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inBuf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects</a></span><span class="op">(</span><span class="va">ptsUniq</span>, <span class="va">buf</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">inBuf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 14</span></span></code></pre>
<p>As demonstrated above, the location-type output of <code>divvy</code>
subsampling functions can be useful in certain cases; however, more
often researchers will want to retrieve taxon records. Changing
<code>output</code> from <code>"locs"</code> to <code>"full"</code>,
each element of the returned object now contains the subset of
occurrence rows from <code>bivalves</code> located at the sites in a
subsample. This output will be useful for analysis in the final vignette
section below.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="co"># same parameter values as above except for 'output'</span></span>
<span><span class="va">circOccs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cookies.html">cookies</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">bivalves</span>, </span>
<span>                    xy <span class="op">=</span> <span class="va">xyCell</span>, </span>
<span>                    iter <span class="op">=</span> <span class="fl">500</span>, </span>
<span>                    nSite <span class="op">=</span> <span class="fl">12</span>, </span>
<span>                    r <span class="op">=</span> <span class="fl">1500</span>, </span>
<span>                    weight <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                    crs <span class="op">=</span> <span class="va">prj</span>,</span>
<span>                    output <span class="op">=</span> <span class="st">'full'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span> <span class="va">circOccs</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           genus paleolng paleolat collection_no reference_no    environment</span></span>
<span><span class="co">#&gt; 83      Anadara   -69.82    10.25         41552        11132  marine indet.</span></span>
<span><span class="co">#&gt; 409  Iliochione   -79.18     0.54         51887        13814       offshore</span></span>
<span><span class="co">#&gt; 410 Undulostrea   -79.18     0.54         51887        13814       offshore</span></span>
<span><span class="co">#&gt; 411  Argopecten   -79.18     0.54         51887        13814       offshore</span></span>
<span><span class="co">#&gt; 412  Argopecten   -79.18     0.54         51881        13814 coastal indet.</span></span>
<span><span class="co">#&gt; 413        Arca   -79.18     0.54         51881        13814 coastal indet.</span></span>
<span><span class="co">#&gt;     max_ma min_ma                accepted_name cell    cellX     cellY</span></span>
<span><span class="co">#&gt; 83   5.333  3.600 Anadara (Larkinia) notabilis 6074 -6543959 1339439.8</span></span>
<span><span class="co">#&gt; 409  5.333  2.588      Iliochione callistoides 7101 -7543959  139439.8</span></span>
<span><span class="co">#&gt; 410  5.333  2.588          Undulostrea megodon 7101 -7543959  139439.8</span></span>
<span><span class="co">#&gt; 411  5.333  2.588       Argopecten ventricosus 7101 -7543959  139439.8</span></span>
<span><span class="co">#&gt; 412  5.333  2.588       Argopecten ventricosus 7101 -7543959  139439.8</span></span>
<span><span class="co">#&gt; 413  5.333  2.588                         Arca 7101 -7543959  139439.8</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="pbdb-collections-references-and-duplicate-entries">PBDB collections, references, and duplicate entries<a class="anchor" aria-label="anchor" href="#pbdb-collections-references-and-duplicate-entries"></a>
</h3>
<p>Data fed into <code>divvy</code> subsampling functions can contain
duplicate taxon–location records, which are common from the
collections-based format of PBDB data entry. For instance, the subsample
output printed above shows <em>Argopecten</em> twice at the same
coordinates. The duplicates stem from different collections (#51881 and
#51887). In the previous section we standardised spatial dispersion and
area, but at this point we could rarefy the number of collections or
references, too, as a standardisation for sampling effort.</p>
<p>The study that developed the circular buffer approach for regional
subsampling (implemented with <code><a href="../reference/cookies.html">cookies()</a></code>) avoided rarefying
collections/references, as this step would be largely redundant with
rarefying sites/raster grid cells <span class="citation">(Antell et al.
2020)</span>. The number of PBDB reference counts for marine
invertebrate occurrences correlates nearly perfectly with grid cell
counts <span class="citation">(Alroy et al. 2008)</span>. Applying
rarefaction to both grid cells and collections or references would
compress the distribution of observed values, which could reduce the
statistical power of analysis and heighten the risk of overlooking a
true biological signal (type 2 error).</p>
<p>In contrast, the study that developed the nearest-neighbour
subsampling approach (described below) rarefied collections within
references, following <span class="citation">Alroy (2014)</span>, but
avoided rarefying sites/cells <span class="citation">(Close et al.
2017)</span>. The richness estimation procedure involved drawing PBDB
references, drawing up to three collections within each of those
references, and evaluating only the taxon occurrences within those
subsampled collections. The <code>divvy</code> diversity summary
function (<code><a href="../reference/sdSumry.html">sdSumry()</a></code>) and the most recent study to use
nearest-neighbour subsamples <span class="citation">(Close et al.
2020)</span> call on the <code>iNEXT</code> implementation of
coverage-based richness estimation, which ignores the PBDB
collections/references data structure. Therefore, users wishing to to
rarefy collections and/or references should write custom richness
estimation scripts or adapt Alroy’s Perl scripts.</p>
<p>To filter out duplicate taxon–location records from a datset, thereby
reducing object size and saving memory, <code>divvy</code> offers the
<code><a href="../reference/uniqify.html">uniqify()</a></code> function. Omitting duplicate occurrences from
<code>bivalves</code> removes more than 5,000 rows.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bivUniq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/uniqify.html">uniqify</a></span><span class="op">(</span><span class="va">bivalves</span>, taxVar <span class="op">=</span> <span class="st">'genus'</span>, <span class="va">xyCell</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bivUniq</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 3061</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="nearest-neighbour-subsampling">Nearest-neighbour subsampling<a class="anchor" aria-label="anchor" href="#nearest-neighbour-subsampling"></a>
</h3>
<p>As mentioned in the preceding section, papers to date that analysed
spatial subsamples constructed with the nearest-neighbour method
constrained only the spatial dispersion and not cumulative area or
number of sites <span class="citation">(Close et al. 2017, 2020)</span>.
For backwards compatibility with these originator publications, the
<code><a href="../reference/clustr.html">clustr()</a></code> function contains an option to turn off site
rarefaction (argument <code>nSite = NULL</code>). However, depending on
study design it may well be prudent to standardise the area/number of
sites when using the nearest-neighbour method, as is mandated in the
circular subsampling method. To set the site quota for either method,
use the <code>nSite</code> argument.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">nnLocs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clustr.html">clustr</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">bivalves</span>, </span>
<span>                 xy <span class="op">=</span> <span class="va">xyCell</span>, </span>
<span>                 iter <span class="op">=</span> <span class="fl">500</span>, </span>
<span>                 distMax <span class="op">=</span> <span class="fl">3000</span>, <span class="co"># diameter = 2x the circular radius set above</span></span>
<span>                 nSite <span class="op">=</span> <span class="fl">12</span>,</span>
<span>                 crs <span class="op">=</span> <span class="va">prj</span></span>
<span>                 <span class="op">)</span></span>
<span><span class="va">nnLocs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;         cellX      cellY</span></span>
<span><span class="co">#&gt; 81   -6343959 1339439.78</span></span>
<span><span class="co">#&gt; 1891 -7343959  -60560.22</span></span>
<span><span class="co">#&gt; 5884 -7343959  539439.78</span></span>
<span><span class="co">#&gt; 6477 -7743959 -460560.22</span></span>
<span><span class="co">#&gt; 1491 -5743959 1339439.78</span></span>
<span><span class="co">#&gt; 2415 -7943959 1139439.78</span></span>
<span><span class="co">#&gt; 409  -7543959  139439.78</span></span>
<span><span class="co">#&gt; 5916 -6543959 1539439.78</span></span>
<span><span class="co">#&gt; 1936 -6743959 2339439.78</span></span>
<span><span class="co">#&gt; 3887 -7743959 1339439.78</span></span>
<span><span class="co">#&gt; 74   -5943959 1339439.78</span></span>
<span><span class="co">#&gt; 5751 -7143959 1339439.78</span></span></code></pre>
<p>If we skip site rarefaction and instead include all locations within
a cluster of maximum diameter deterministically, a subsample built on a
given starting location could include any number of sites above the
minimum threshold (here, <code>nMin = 3</code>, the default). The first
replicate in this example contains 17 sites.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">nnAllSites</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clustr.html">clustr</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">bivalves</span>, </span>
<span>                     xy <span class="op">=</span> <span class="va">xyCell</span>, </span>
<span>                     iter <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                     distMax <span class="op">=</span> <span class="fl">3000</span>, <span class="co"># diameter = 2x the circular radius set above</span></span>
<span>                     nMin <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     crs <span class="op">=</span> <span class="va">prj</span></span>
<span>                     <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span> <span class="va">nnAllSites</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 17</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="latitudinal-subsampling">Latitudinal subsampling<a class="anchor" aria-label="anchor" href="#latitudinal-subsampling"></a>
</h3>
<p>Many biological and environmental variables of interest vary
characteristically with latitude. Hence, depending on research question
it may be exigent to control for latitudinal differences between items
of comparison, e.g. occurrence data from a time step with predominantly
low-latitude fossil localities vs. a time step with more mid-latitude
localities.</p>
<p>The <code><a href="../reference/bandit.html">bandit()</a></code> function returns subsamples of a given site
quota within latitudinal bands of a given bin resolution/width.
Optionally, the function will ignore hemisphere differences and consider
absolute latitude. The <code>iter</code> argument in
<code><a href="../reference/bandit.html">bandit()</a></code> specifies the number of subsamples to take within
each band, rather than the total number globally. No subsamples are
returned in bands containing fewer than <code>nSite</code>
localities.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bandLocs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bandit.html">bandit</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">bivalves</span>,</span>
<span>                   xy <span class="op">=</span> <span class="va">xyCell</span>,</span>
<span>                   iter <span class="op">=</span> <span class="fl">100</span>, nSite <span class="op">=</span> <span class="fl">12</span>, </span>
<span>                   bin <span class="op">=</span> <span class="fl">20</span>, <span class="co"># interval width in degrees</span></span>
<span>                   crs <span class="op">=</span> <span class="va">prj</span></span>
<span>                   <span class="co"># ,absLat = TRUE # optional</span></span>
<span>                   <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">bandLocs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># number of sites in one subsampled band</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 12</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bandLocs</span><span class="op">)</span> <span class="co"># number of subsamples, tallied across all bands</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 500</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bandLocs</span><span class="op">)</span><span class="op">)</span> <span class="co"># latitudinal degrees of subsampled intervals</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "[-50,-30)" "[-10,10)"  "[10,30)"   "[30,50)"   "[50,70)"</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="analysis-on-subsampled-data">Analysis on subsampled data<a class="anchor" aria-label="anchor" href="#analysis-on-subsampled-data"></a>
</h2>
<p>The <code><a href="../reference/sdSumry.html">sdSumry()</a></code> function returns a summary of the spatial
characteristics of a dataset/subsample: number of unique locations,
centroid coordinates, latitudinal range (degrees), great circle distance
(km), and summed minimum spanning tree length (km) for occurrences.
<code><a href="../reference/sdSumry.html">sdSumry()</a></code> also tallies taxa in a sample and performs
coverage-based rarefaction (if <code>quotaQ</code> supplied) and
classical rarefaction (if <code>quotaN</code> supplied). Rarefied
estimates are returned along with their associated 95% confidence
interval (estimated by <code>iNEXT</code>).</p>
<p>When coverage-based rarefaction is applied, the specified coverage
level (<code>quotaQ</code>) should be appropriate for the estimated
coverage of the original sample. Any requested quota greater than
empirically available will require diversity extrapolation.
<code><a href="../reference/sdSumry.html">sdSumry()</a></code> returns the estimated sample coverage whenever
coverage-based rarefaction is applied. Also note, homogeneous evenness
is an underlying assumption for fair comparisons of coverage-based
rarefaction diversity estimates. To help check this assumption,
<code><a href="../reference/sdSumry.html">sdSumry()</a></code> also returns Pielou’s J evenness metric whenever
coverage-based rarefaction is applied. Evenness metrics are an area of
ongoing theoretical debate and methodological development in ecology,
and the use of Pielou’s J in <code>divvy</code> is a reflection of this
metrics’ widespread use rather than a singular endorsement. If J
estimates vary widely between time intervals or other categories of
comparison, it is worth investigating evenness differences in more
nuanced detail, for instance by calculating a variety of metrics.</p>
<p>Compare the summary data from the original dataset vs. a single
spatial subsample. First consider the summary of spatial metrics. The
geographic dispersion of <code>bivalves</code> occurrences is
enormous—this in itself indicates spatial standardisation is necessary
to derive meaningful biological metrics. When we compare diversity
estimates from the global vs. spatially-subsampled dataset, richness
estimates are much higher for the global dataset, regardless of
rarefaction method. This result demonstrates the species–area effect
described in the introduction: even when rarefaction is applied to the
same quota or coverage level, diversity estimates are larger for
datasets with greater spatial coverage, because rarefaction fails to
control spatial turnover in diversity.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unsamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdSumry.html">sdSumry</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">bivalves</span>, </span>
<span>                  taxVar <span class="op">=</span> <span class="st">'genus'</span>,</span>
<span>                  collections <span class="op">=</span> <span class="st">'collection_no'</span>,</span>
<span>                  xy <span class="op">=</span> <span class="va">xyCell</span>,</span>
<span>                  quotaQ <span class="op">=</span> <span class="fl">0.8</span>, quotaN <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                  omitDom <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                  crs <span class="op">=</span> <span class="va">prj</span><span class="op">)</span></span>
<span><span class="va">unsamp</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   nColl nOcc nLoc centroidX centroidY latRange greatCircDist meanPairDist</span></span>
<span><span class="co">#&gt; 1   863 3061  157 -434404.9   1647720 137.4159      28917.12     11375.07</span></span>
<span><span class="co">#&gt;   minSpanTree     SCOR nTax  evenness coverage  SQSdiv SQSlow95 SQSupr95</span></span>
<span><span class="co">#&gt; 1    93349.91 20.64401  550 0.9061343   0.9414 323.015 310.6638 335.3662</span></span>
<span><span class="co">#&gt;      CRdiv  CRlow95  CRupr95</span></span>
<span><span class="co">#&gt; 1 470.9424 454.3334 487.5515</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdSumry.html">sdSumry</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">circOccs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, </span>
<span>                 taxVar <span class="op">=</span> <span class="st">'genus'</span>,</span>
<span>                 collections <span class="op">=</span> <span class="st">'collection_no'</span>,</span>
<span>                 xy <span class="op">=</span> <span class="va">xyCell</span>,</span>
<span>                 quotaQ <span class="op">=</span> <span class="fl">0.8</span>, quotaN <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                 omitDom <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 crs <span class="op">=</span> <span class="va">prj</span><span class="op">)</span></span>
<span><span class="va">samp1</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   nColl nOcc nLoc centroidX centroidY latRange greatCircDist meanPairDist</span></span>
<span><span class="co">#&gt; 1   134  442   12  -7027292   4139440 10.25901      1612.452     779.4877</span></span>
<span><span class="co">#&gt;   minSpanTree     SCOR nTax  evenness coverage  SQSdiv SQSlow95 SQSupr95</span></span>
<span><span class="co">#&gt; 1    2648.528 46.01033  164 0.9572183   0.8704 136.402 123.5963 149.2078</span></span>
<span><span class="co">#&gt;      CRdiv CRlow95  CRupr95</span></span>
<span><span class="co">#&gt; 1 219.8183 190.056 249.5806</span></span></code></pre>
<p>Iterative spatial subsampling addresses this issue in that it can
control for <em>beta</em> diversity in global occurrence datasets. Even
though any individual subsample includes only a fraction of the total
occurrences, all data can contribute to analyses through repeated
subsampling. Ecological variables calculated on any given subsample are
directly comparable to those from other subsamples on the same dataset
or a comparison dataset (e.g. a different time step or habitat type).
The code chunk below demonstrates how to calculate summary statistics
over all subsamples of Pliocene bivalve occurrences. The median taxon
count in a 1500km-radius subsample is 162, with an interquartile range
of 126–183 taxa. This range can be interpreted loosely as primary
regional variation in estimated palaeodiversity.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># warning - it's slow to rarefy diversity for hundreds of subsamples!</span></span>
<span><span class="co"># this code chunk skips it for quick demonstration purposes</span></span>
<span><span class="va">sampsMeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdSumry.html">sdSumry</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">circOccs</span>, </span>
<span>                     taxVar <span class="op">=</span> <span class="st">'genus'</span>,</span>
<span>                     collections <span class="op">=</span> <span class="st">'collection_no'</span>,</span>
<span>                     xy <span class="op">=</span> <span class="va">xyCell</span>,</span>
<span>                     crs <span class="op">=</span> <span class="va">prj</span></span>
<span>                     <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">sampsMeta</span><span class="op">$</span><span class="va">nTax</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; 25% 50% 75% </span></span>
<span><span class="co">#&gt; 126 162 183</span></span></code></pre>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Alroy2010" class="csl-entry">
Alroy, John. 2010. <span>“The Shifting Balance of Diversity Among Major
Marine Animal Groups.”</span> <em>Science</em> 329 (5996): 1191–94. <a href="https://doi.org/10.1126/science.1189910" class="external-link">https://doi.org/10.1126/science.1189910</a>.
</div>
<div id="ref-Alroy2014" class="csl-entry">
———. 2014. <span>“Accurate and Precise Estimates of Origination and
Extinction Rates.”</span> <em>Paleobiology</em> 40 (3): 374–97. <a href="https://doi.org/10.1666/13036" class="external-link">https://doi.org/10.1666/13036</a>.
</div>
<div id="ref-Alroy2008" class="csl-entry">
Alroy, John, Martin Aberhan, David J Bottjer, Michael Foote, Franz T
Fürsich, Peter J Harries, Austin J W Hendy, et al. 2008.
<span>“Phanerozoic Trends in the Global Diversity of Marine
Invertebrates.”</span> Journal Article. <em>Science</em> 321 (5885):
97–100. <a href="https://doi.org/10.1126/science.1156963" class="external-link">https://doi.org/10.1126/science.1156963</a>.
</div>
<div id="ref-Antell2020" class="csl-entry">
Antell, Gawain T, Wolfgang Kiessling, Martin Aberhan, and Erin E Saupe.
2020. <span>“Marine Biodiversity and Geographic Distributions Are
Independent on Large Scales.”</span> Journal Article. <em>Current
Biology</em> 30 (1): 115–21. <a href="https://doi.org/10.1016/j.cub.2019.10.065" class="external-link">https://doi.org/10.1016/j.cub.2019.10.065</a>.
</div>
<div id="ref-Benson2021" class="csl-entry">
Benson, Roger BJ, Richard Butler, Roger A Close, Erin Saupe, and Daniel
L Rabosky. 2021. <span>“Biodiversity Across Space and Time in the Fossil
Record.”</span> <em>Current Biology</em> 31 (19): R1225–36. <a href="https://doi.org/10.1016/j.cub.2021.07.071" class="external-link">https://doi.org/10.1016/j.cub.2021.07.071</a>.
</div>
<div id="ref-Chao2012" class="csl-entry">
Chao, Anne, and Lou Jost. 2012. <span>“Coverage-Based Rarefaction and
Extrapolation: Standardizing Samples by Completeness Rather Than
Size.”</span> <em>Ecology</em> 93 (12): 2533–47. <a href="https://doi.org/10.1890/11-1952.1" class="external-link">https://doi.org/10.1890/11-1952.1</a>.
</div>
<div id="ref-Close2020" class="csl-entry">
Close, Roger A, Roger B J Benson, Erin E Saupe, Michael E Clapham, and
Richard J Butler. 2020. <span>“The Spatial Structure of Phanerozoic
Marine Animal Diversity.”</span> Journal Article. <em>Science</em> 368
(6489): 420–24. <a href="https://doi.org/10.1126/science.aay8309" class="external-link">https://doi.org/10.1126/science.aay8309</a>.
</div>
<div id="ref-Close2017" class="csl-entry">
Close, Roger A, Roger B J Benson, Paul Upchurch, and Richard J Butler.
2017. <span>“Controlling for the Species-Area Effect Supports
Constrained Long-Term Mesozoic Terrestrial Vertebrate
Diversification.”</span> Journal Article. <em>Nature Communications</em>
8. <a href="https://doi.org/10.1038/ncomms15381" class="external-link">https://doi.org/10.1038/ncomms15381</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Gawain Antell.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
